# HRTF 3D éŸ³æ•ˆ Matlabå®ç°

# å°Šé‡åŸåˆ›ï¼Œè¯·å‹¿è½¬è½½! 
ä½œè€…ï¼š[å›¾æ—æ ¹ã®çƒ¤è‚ ](https://www.thueringerbratwurst.com)

>2020å¹´6æœˆæ³¨ï¼šå› ä¸ºå¹´ä»£å®åœ¨ä¹…è¿œï¼Œæ‰‹å¤´ç›®å‰åœ¨å¿™äº Unity å’Œ AR é¡¹ç›®çš„äº‹æƒ…ï¼Œè¿˜æœ‰ä¸å°‘ iOS çš„ app å¾…å¼€å‘ï¼Œå¾…æ—¶é—´èµ‹äºˆä¼šæŠ½ç©ºå†™ä¸€ç¯‡é€šè¿‡ Python å®ç°çš„å†…å®¹ï¼Œè¿˜è¯·è§è°…ï½

>CIPIC HRTF çš„æ•°æ®å·²ç»æ‰¾åˆ°ï¼Œæ„Ÿè°¢â€˜æµ·é˜”å¤©ç©ºâ€™åŒå­¦çš„å¸®åŠ©ï¼Œ[Github ä¸‹è½½é“¾æ¥](https://github.com/amini-allight/cipic-hrtf-database)ï¼Œæ— è¿‡æ— æ³•ä¸‹è½½æˆ‘ä¹ŸæŠŠæ•°æ®æ”¾åˆ°äº†ç™¾åº¦ç½‘ç›˜ã€‚

## ä»‹ç»
è®²å®Œäº† [ä¸Šä¸€ç¯‡](../hrtf/) å¯¹å®ç°æ–¹æ³•ï¼Œç»“ä¸‹æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å®é™…æ‰§è¡Œä»£ç äº†ã€‚æœ¬ç¯‡æ–‡ç« çš„ä»£ç éƒ½å¯ä»¥ä»æˆ‘çš„ [Github](https://github.com/Asues/Matlab/tree/master/HRTF) ä¸­çš„ `HRTFæ–‡ä»¶å¤¹` ä¸­æ‰¾åˆ°ã€‚å¦‚æœ Github æ— æ³•ä¸‹è½½ï¼Œå¯ä»¥ç§»æ­¥ [ç™¾åº¦ç½‘ç›˜](https://pan.baidu.com/s/1dslhSYPa3bqSkioPjJtwpw) å¯†ç :`lyi6`ã€‚

é¦–å…ˆä¸€å¥è¯æ¦‚æ‹¬3DéŸ³é¢‘å®ç°çš„åŸç†ï¼šæ‰¾åˆ°å¯¹åº”ç©ºé—´çš„HRIRæ•°å€¼ï¼Œç„¶åå·ç§¯éŸ³é¢‘ä¿¡å·å³å¯ï¼Œæ˜¯ä¸æ˜¯çœ‹ä¸Šå»å¾ˆç®€å•ğŸ˜€

## æ€»ä½“æ¦‚è§ˆ
é¦–å…ˆä¸»è¦ä»‹ç»ä¸€ä¸‹è¿™äº›æ–‡ä»¶çš„åŠŸèƒ½ï¼š
  1. doc æ–‡ä»¶å¤¹é‡Œé¢æ˜¯å…³äº CIPIC HRTF çš„æ–‡æ¡£è¯´æ˜ï¼Œå…·ä½“ç›¸å…³çš„èµ„æ–™ä¹Ÿå¯ä»¥å‚è€ƒ ~~[CIPIC å®˜ç½‘](http://interface.cipic.ucdavis.edu/sound/hrtf.html)~~ï¼Œä¸ªäººå»ºè®®ä¸‹è½½å®˜æ–¹çš„é‚£ä¸ªå…¨éƒ¨ Matlab æ–‡æ¡£ï¼ˆMATLAB versionï¼‰ï¼Œæ€»è®¡170 Mb å·¦å³, åœ¨ä¸‹è½½å®Œæˆåå¯ä»¥è¿è¡Œé‡Œé¢çš„`showdata.m`æ–‡ä»¶ï¼Œä»è€ŒæŸ¥çœ‹å„ä¸ªä½ç½®ç›¸å…³çš„é¢‘è°±ä¿¡æ¯ã€‚
  2. `audio\_with\_brir.m` è¯¥å‡½æ•°æ˜¯ä¸»è¦ç®—æ³•ï¼Œæè¿°äº†éŸ³é¢‘æ–‡ä»¶å¦‚ä½•ä¸ HRTFæ•°æ®è¿›è¡Œå·ç§¯ï¼Œä»è€Œå®ç°3DéŸ³æ•ˆã€‚
  3. `hrir\_final.mat`æ˜¯ CIPCI KEMAR 21å·ï¼ˆSubject\_021ï¼‰çš„ HRTF æ•°æ®ï¼Œè¯¥æ•°æ®é‡‡ç”¨äº†å¤§è€³å»“è¿›è¡Œé‡‡é›†ã€‚
  4. `load\_CIPIC\_HRIR.m`çš„ä¸»è¦åŠŸèƒ½æ˜¯è¯»å– `hrir\_final.mat` çš„å·¦å³è€³ HRIR æ•°æ®ï¼Œç„¶ååœ¨ç”¨äº`audio\_with_brir.m`æ–‡ä»¶è¿›è¡Œä¿¡å·å·ç§¯ã€‚
  5. `nokia.wav` è¿™ä¸ªä¸ç”¨å¤šè¯´äº†ï¼Œä¸€æ®µæµ‹è¯•éŸ³é¢‘ï¼Œè¯ºåŸºäºšçš„ç»å…¸é“ƒå£°ã€‚
  6. `main.m` ä¸ºä»£ç çš„è¿è¡Œçš„ä¸»æ–‡ä»¶ã€‚

ä¸‹é¢å¼€å§‹åˆ†åˆ«å¯¹å„ä¸ªæ–‡ä»¶è¿›è¡Œè§£é‡Šè¯´æ˜ï¼š

## ä»£ç ä»‹ç»
### è¯»å–HRTFå‡½æ•°

åœ¨æ–‡ä»¶ `doc/hrir_data_documentation.pdf`ä¸­ï¼Œæ ‡æ˜äº†è¯¥ HRTF æ•°æ®çš„ç©ºé—´åæ ‡ç³»å¯ä»¥è§£é‡Šä¸ºï¼šä¸å¤´éƒ¨æ°´å¹³çš„`Azimutæ–¹ä½è§’` å’Œå¤´éƒ¨å‚ç›´çš„ `Elevation ç«‹ä½“è§’`ã€‚å…¶ä¸­ Azimut ä»¥å¤´éƒ¨æ­£å‰æ–¹ä¸º0åº¦ï¼Œ-90Â°ä¸ºå·¦è€³æ–¹å‘ï¼Œ+90Â°ä¸ºå³è€³æ–¹å‘ã€‚å–å€¼ä¸º `[-80:-65:-55:-45:5:45:55:65:80]` ä¸€å…±25ä¸ªç‚¹ï¼Œå…¶ä¸­ä»-45Â°åˆ°45Â°æ¢¯åº¦ä¸º5Â°ã€‚Elevation çš„å–å€¼èŒƒå›´ä¸º [-45 + 5.625 Â * ï¼ˆ0ï¼š49ï¼‰]ä¸€å…±50ä¸ªé‡‡æ ·ç‚¹ï¼Œå…¶ä¸­ä½äºå¤´éƒ¨ä¸ºè´Ÿå€¼ï¼Œé«˜äºå¤´éƒ¨ä¸ºæ­£å€¼ã€‚è¯´å¾—æœ‰äº›æŠ½è±¡ï¼Œçœ‹ä¸‹é¢ä¸€å¼ å›¾ä¾¿ä¸€è·¯äº†ç„¶ã€‚
{{< figure src="ks.png" title="Azimuth & Elevation" >}}

å›¾aä»å·¦å¾€å³æ•°æœ‰25ä¸ªç‚¹ï¼ˆ25åˆ—ï¼Œå¯ä»¥æƒ³åƒæŠŠæ‰‹è‡‚ä¼¸ç›´ï¼ŒæŒ‡å‘ä½ çš„æ­£å‰æ–¹ï¼Œç„¶åå·¦å³ç§»åŠ¨æ‰‹è‡‚ç”»å‡ºå¹³è¡Œäºçœ¼å‰çš„ä¸€ä¸ªå¼§å½¢ï¼Œè¿™ä¸ªæ‰‡å½¢å¹³é¢ç”±25ä¸ªç‚¹ç»„æˆï¼‰ï¼Œä¸ä¹‹å¯¹åº”çš„å³ä¸ºAzimutï¼Œå›¾bå¯¹åº”çš„ä¸º Elevationï¼Œä¸€å…±50ä¸ªé‡‡æ ·ç‚¹(åŒç†æ‰‹è‡‚ä¼¸ç›´ï¼Œä¸Šä¸‹æ‘†åŠ¨ç»„æˆå¦ä¸€ä¸ªæ‰‡å½¢å¹³é¢ï¼Œè¿™ä¸ªå¹³é¢ä¸€å…±50æ¨ªè¡Œï¼Œä»Bå›¾ä¸­å³é¢é€†æ—¶é’ˆæ•°å³å¯)ã€‚

æ¥ä¸‹æˆ‘ä»¬æ¥çœ‹HRTFçš„æ•°æ®æ–‡ä»¶ï¼ŒåŒå‡»é€šè¿‡ Matlab è°ƒç”¨`hrir\_final.mat`æ–‡ä»¶åä¼šå‘ç°ï¼Œ`hrir\_l ä¸ hrir\_r`å°±æ˜¯ä¸ä¹‹å¯¹åº”çš„å·¦å³è€³HRIRæ•°æ®ã€‚ä½†æ˜¯éšä¹‹æ¥çš„é—®é¢˜å°±æ˜¯`hrir\_l`çš„æ–‡ä»¶ size æ˜¯ `25 x 50 x 200` ï¼Œè¿™æ˜¯å› ä¸º HRTF çš„æ•°æ®æ˜¯ä¸€ä¸ªä¸‰ç»´ç©ºé—´æ•°æ®ï¼Œå…¶ä¸­çš„25è¡¨ç¤ºçš„æ˜¯ Azimutï¼ˆå›¾aï¼‰ï¼Œ50ä¸º Elevationï¼ˆå›¾bï¼‰ï¼Œ200ä¸ºè¯¥ç‚¹çš„æ•°æ®ã€‚å‡å¦‚æˆ‘ä»¬éœ€è¦å–ä¸€ä¸ªå¹³è¡Œäºå¤´éƒ¨æ­£å‰æ–¹å’Œæ­£åæ–¹çš„ä¸€ä¸ªåœ†å½¢åŒºåŸŸï¼Œç”±å›¾bçš„ç´«è‰²æ¨ªçº¿å¯çŸ¥ï¼Œè„¸éƒ¨æ­£å‰æ–¹çš„ Elevation å¯¹åº”çš„ç‚¹çš„æ•°å€¼é¡ºåºä¸º9ï¼ˆå›¾bï¼Œé€†æ—¶é’ˆæ•°ï¼Œç´«è‰²çš„çº¿ä¸ºç¬¬9ï¼‰ï¼Œè¯·ä¸è¦å¿˜è®° Azimutçš„å–å€¼èŒƒå›´ä¸ºå·¦è€³`-80Â°`åˆ°å³è€³`+80Â°`çš„ä¸€ä¸ªæ‰‡å½¢åŒºåŸŸï¼Œæ‰€ä»¥è¿™æ—¶å€™æˆ‘ä»¬å¾—åˆ°çš„æ•°æ®åªæ˜¯å¤´éƒ¨å‰é¢çš„åŠæ‰‡å½¢åŒºåŸŸã€‚ä¸ºäº†æ›´å¥½åœ°ç†è§£ï¼Œå¯ä»¥æŠŠåŒæ‰‹åˆ†åˆ«å‘å·¦å³è€³çš„æ–¹å‘ä¼¸å±•ä¸º80Â°ï¼Œè¿™æ—¶å€™åŒæ‰‹å›´æˆçš„ä¸€ä¸ªæ°´å¹³æ‰‡å½¢åŒºåŸŸå°±æ˜¯å›¾aæ‰€ç¤ºçš„åŒºåŸŸï¼Œè¿™æ—¶å€™å†æŠŠåŒæ‰‹ä¸€åŒä¸Šä¸‹ç§»åŠ¨ï¼Œå°±ä¼šæ„æˆå¦‚å›¾bä¸­ä¸€æ ·çš„ä¸€ä¸ªä¸‰ç»´ç©ºé—´ã€‚è¿™æ—¶å€™æˆ‘ä»¬æŠŠç´«çº¿å»¶ä¼¸åˆ°å›¾aå¯ä»¥çœ‹åˆ°ï¼Œå¤´éƒ¨æ­£åæ–¹ Elevation ä¸º41çš„åŒºåŸŸï¼Œæ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„åæ–¹åŒºåŸŸã€‚æ˜ç™½äº†ä¸Šé¢çš„åŸç†ï¼Œå†æ¥çœ‹ä»£ç ç¬¬22è¡Œã€‚

```matlab
%ï¼ˆload_CIPIC_HRIR.mï¼‰
out = [squeeze(hrir_l(:,front,:));flip(squeeze(hrir_l(:,back,:)),1)];      
```
è¯¥è¡Œä»£ç çš„æ„ä¹‰ä¸ºï¼šå…ˆå–å¤´éƒ¨æ­£å‰æ–¹ Elevation ä¸º front çš„25ä¸ªæ°´å¹³é¢ä¸Šçš„ç‚¹ï¼Œå†å–è„¸éƒ¨åæ–¹ Elevationä¸º back çš„25ä¸ªæ°´å¹³é¢ä¸Šé¢çš„ç‚¹ç¿»è½¬ååœ¨åˆå¹¶ï¼Œå°±ç»„æˆäº†ä¸€ä¸ªç”±50ä¸ªç‚¹ç»„æˆçš„æ°´å¹³é¢ã€‚è‡³äºè¯´ä¸ºä»€ä¹ˆè¦ç¿»è½¬åå¹³é¢ï¼Œå› ä¸º hrtf çš„å–å€¼æ˜¯æŒ‰ç…§é¡ºæ—¶é’ˆé‡‡æ ·çš„ï¼Œè€ŒååŠéƒ¨æ•°æ®æ˜¯å‰åŠéƒ¨æ•°æ®çš„é•œåƒï¼Œä¸ç¿»è½¬æ•°æ®ç›´æ¥è¿›è¡Œå·ç§¯åä¼šå‘ç°å£°éŸ³æ˜¯ä»[-80->0->80->-80->-180->80]çš„é¡ºåºæ’­æ”¾ã€‚

### å·ç§¯å‰çš„æ“ä½œ

å¾—åˆ°äº† HRIR æ•°æ®åæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹æ­£å¼è¿›è¡Œä¿¡å·çš„å·ç§¯äº†ï¼Œè¿™é‡Œæˆ‘å‡è®¾æ‚¨å·²ç»é˜…è¯»å®Œæˆ‘ [å‰ä¸€ç¯‡](../hrtf/) çš„æ–‡ç« å¹¶ä»¥ç†è§£å…¶åŸç†ã€‚

é¦–å…ˆæ¥çœ‹`audio_with_brir.m`å‡½æ•°çš„33åˆ°38è¡Œ:
```matlab
% if the remainder not equal to zero,then calculate the padding zeros
if remainder > 0 
   padding_zero = points_number - remainder;

   % padding zeros with audio file
   audioIn = [audioIn zeros(1,padding_zero)];
end
```
è¿™æ®µä»£ç çš„æ„ä¹‰æ˜¯ä¸ºäº†è¿›è¡Œç»™éŸ³é¢‘æœ«å°¾è¡¥é›¶ï¼Œä»¥ä¾¿èƒ½å¤Ÿè®©è¾“å…¥éŸ³é¢‘å¹³å‡åˆ†æˆNç­‰åˆ†ã€‚ç®—æ³•å°±æ˜¯é¦–æŒ‰ç…§è¾“å…¥çš„ BRIR æ•°æ®æœ‰å¤šå°‘ä¸ªçºµåˆ—å€¼ï¼ˆBRIR å¿…é¡»åŒ…æ‹¬å·¦å³è€³çš„æ•°æ®ï¼Œå¹¶ä¸”æ•°å€¼ä¸ºçºµåˆ—ï¼‰æ¥è¿›è¡ŒéŸ³é¢‘çš„ N ç­‰åˆ†ï¼Œè¿™é‡Œä¸º`points_number`ï¼Œç„¶åæŸ¥çœ‹éŸ³é¢‘çš„æ€»é•¿åº¦é™¤ä»¥éœ€è¦ N ç­‰åˆ†çš„ä½™æ•°æ¥è¿›è¡Œè¡¥é›¶ã€‚è¿˜æ˜¯ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œ`11/4` ä½™æ•°ä¸º `3`ï¼Œåˆ™éœ€è¦è¡¥é›¶çš„ä¸ªæ•°ä¸º `4 - 3 = 1`ã€‚

æ¥ä¸‹æ¥å°±æ˜¯è®¾è®¡çª—å‡½æ•°æ¥è¿›è¡Œæ·¡å…¥æ·¡å‡ºï¼Œä»¥åŠé«˜é€šä¸ä½é€šçš„æ»¤æ³¢å™¨ï¼Œè¿™é‡Œçš„æˆªæ­¢é¢‘ç‡åˆ†åˆ«ä¸º`20kHz`ä¸`20Hz`ã€‚

ç¬¬55åˆ°64è¡Œï¼ŒLå’ŒRåˆ†åˆ«ä¸ºå·¦å³è€³ï¼Œå³ä¸ºéŸ³é¢‘åˆ†å‰²åçš„éŸ³é¢‘ç‰‡æ®µä¸ BRIR æ•°æ®è¿›è¡Œå·ç§¯ã€‚
```matlab
for i = 1 : points_number % because brir has only 6 points in Azimut   {300, 330, 0, 60, 120, 180}

    % faltung å·ç§¯ 
    L = filter(brir(:,2*i-1)',1,audioIn(1,step*(i-1)+1:step*i));
    R = filter(brir(:,2*i)',1,audioIn(1,step*(i-1)+1:step*i));

    segment_L(i,:) = L;
    segment_R(i,:) = R;
end
```
ç„¶åæ˜¯67åˆ°78è¡Œï¼šä¸ºäº†ä»£ç æ–¹ä¾¿ï¼Œè¿™é‡Œçš„æŠŠéŸ³é¢‘çš„ç‰‡æ®µ1å’Œç‰‡æ®µæœ€åä¸€æ®µä¹Ÿè¿›è¡Œäº†æ·¡å…¥æ·¡å‡ºæ•ˆæœï¼Œè™½ç„¶æˆ‘ä»¬ä¸éœ€è¦ç¬¬ä¸€æ®µå¼€å¤´çš„æ·¡å…¥å’Œæœ€åä¸€æ®µçš„æ·¡å‡ºï¼Œä½†æ˜¯åŠ ä¸Šåä¹Ÿæ— å¦¨ã€‚
```matlab
% ä¿¡å·çš„æ·¡å…¥æ·¡å‡ºæ“ä½œ
for n = 1 : points_number
    % the last segment need only fade in, so we make that later, first make
    % fade in and fade out except the last segment
    % add fade in for each segment at the beginning
    segment_L(n,1:window_N/2) = segment_L(n,1:window_N/2) .* window(1:window_N/2);  
    segment_R(n,1:window_N/2) = segment_R(n,1:window_N/2) .* window(1:window_N/2); 

    % add fade out for each segment at the end
    segment_L(n,(end - window_N/2 + 1):end) = segment_L(n,(end - window_N/2 + 1):end) .* window((window_N/2+1):end); 
    segment_R(n,(end - window_N/2 + 1):end) = segment_R(n,(end - window_N/2 + 1):end) .* window((window_N/2+1):end);    
end
```

86å’Œ87è¡Œä¸ºå¯¹ç¬¬ä¸€ä¸ªéŸ³é¢‘ç‰‡æ®µçš„æ“ä½œï¼š
```matlab
left = [segment_L(1,1:end - (window_N/2)) segment_L(1,(end - window_N/2 +1):end) + segment_L(2,1:(window_N/2))];  
right = [segment_R(1,1:end - (window_N/2)) segment_R(1,(end - window_N/2 + 1):end) + segment_R(2,1:(window_N/2))];
```

93åˆ°96ä¸ºç›´åˆ°å€’æ•°ç¬¬äºŒä¸ªéŸ³é¢‘ç‰‡æ®µçš„åˆå¹¶ã€‚
```matlab
% except the last segment
for n = 2 : points_number - 1 
    left = [left segment_L(n,(window_N/2+1):end-(window_N/2)) segment_L(n,(end - window_N/2 + 1):end) + segment_L(n+1,1:(window_N/2))];
    right = [right segment_R(n,(window_N/2+1):end-(window_N/2)) segment_R(n,(end - window_N/2 + 1):end) + segment_R(n+1,1:(window_N/2))];
end
```

100åˆ°120è¡Œä¸ºæœ€åä¸€æ®µç‰‡æ®µçš„åˆå¹¶ã€‚
```matlab
n = points_number;
left = [left segment_L(n,(window_N/2 +1):end)];
right = [right segment_R(n,(window_N/2 + 1):end)];
```
ä½™ä¸‹çš„ä»£ç å°±æ˜¯éŸ³é¢‘çš„å½’ä¸€åŒ–ä¸æ»¤æ³¢ã€‚

## ä¿¡å·å·ç§¯

æ˜ç™½äº†ä¸Šé¢ä¸¤ä¸ªå‡½æ•°çš„åŠŸèƒ½åæˆ‘ä»¬å¯ä»¥å¼€å§‹æ­£å¼è¿›è¡Œä¿¡å·çš„å·ç§¯æ“ä½œï¼Œè¿™æ—¶å€™æ¥çœ‹`main`æ–‡ä»¶ï¼Œ15,16è¡Œè°ƒç”¨äº†load_CIPIC_HRIRå‡½æ•°ï¼Œåˆ†åˆ«è¯»å–äº† Elevation ä¸º9å’Œ41çš„æ•°å€¼ã€‚
```matlab
hrir_l = load_CIPIC_HRIR(hrir_fn,front,back,'left');
hrir_r = load_CIPIC_HRIR(hrir_fn,front,back,'right');
```

22åˆ°26è¡ŒæŠŠæ‰€å¾—åˆ°çš„æ‰€æœ‰HRIRæ•°æ®åˆ†åˆ«æŒ‰ç…§å·¦è€³1ï¼Œå³è€³1ï¼Œå·¦è€³2ï¼Œå³è€³2ç­‰ç­‰æ•´åˆåˆ°äº†ä¸€èµ·ã€‚
```matlab
hrir = [];
for i = 1:size(hrir_l,2)
    hrir(:,i*2-1) = hrir_l(:,i);
    hrir(:,i*2) =  hrir_r(:,i);
end
```
æœ€åå°±æ˜¯`audio_with_brir`å‡½æ•°ï¼Œè¾“å…¥å‚æ•°ä¸ºéŸ³é¢‘æ–‡ä»¶ä¸æœ€åçš„ HRIRã€‚ç„¶åå‘¢ï¼Ÿæ²¡æœ‰ç„¶åäº†ï¼Œèµ¶ç´§æ¥å¬å¬è¯ºåŸºäºšçš„ç¯ç»•éŸ³æ•ˆå§ã€‚

## è§£è¯­
ä»¥ä¸Šå°±æ˜¯æœ€è¿‘å‡ å¤©æ¥å…³äºæœ¬ç§‘æ¯•è®¾ä¸­ HRTF çš„ä¸€äº›ç¼–ç¨‹æ€»ç»“ï¼Œå¦‚æœæƒ³é‡‡ç”¨å…¶å®ƒç¯ç»•æˆ–è€…æœ‰ä¸ªæ€§çš„æ–¹æ³•ï¼Œåªéœ€è¦è¯»å–ä¸åŒç©ºé—´ä½ç½®çš„ HRIR æ•°æ®å³å¯ã€‚å¦‚ä»æœ‰å…¶å®ƒé—®é¢˜çš„è¯ï¼Œæ¬¢è¿é‚®ä»¶å’¨è¯¢ã€‚
æœ€åç¥æ„¿å„ä½2016æ–°å¹´å¿«ä¹~
